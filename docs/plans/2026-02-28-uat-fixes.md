# UAT Fixes Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Address all UAT findings from live testing session: surprise entrant limits, leader badge ties, fullscreen popup behavior, font scaling, layout fixes, and game-end screens.

**Architecture:** Each fix is isolated to specific components with no cross-task dependencies. Display app fixes touch `components/pick-em/live-display/` and `components/pick-em/shared/`. Player app fixes touch `components/pick-em/live-player/` and `components/pick-em/live-game-player-app.tsx`. Event routing changes touch `components/pick-em/live-game-display-app.tsx` and the fullscreen effects hook.

**Tech Stack:** React, TypeScript, Tailwind CSS, Framer Motion (motion/react)

---

### Task 1: Enforce surprise entrant limit in player app

The player app currently lets users add unlimited surprise entrants. The match has `match.surpriseSlots` indicating the maximum allowed. We need to show the limit and disable adding once reached.

**Files:**
- Modify: `components/pick-em/live-player/player-match-picks.tsx`

**Step 1: Show the limit count in the Surprise Entrants label**

In `player-match-picks.tsx`, change the label at line 145 from:

```tsx
<Label>Surprise Entrants</Label>
```

to:

```tsx
<Label>
  Surprise Entrants ({battleRoyalEntrants.length}/{match.surpriseSlots})
</Label>
```

**Step 2: Disable input and button when limit reached**

Add a derived boolean after `battleRoyalFieldKey` (around line 84):

```tsx
const isSurpriseEntrantsFull =
  battleRoyalEntrants.length >= match.surpriseSlots;
```

Then update the `<Input>` at line 147 to add the disabled condition:

```tsx
disabled={isMatchLocked || isSurpriseEntrantsFull}
```

And the "Add Entrant" `<Button>` at line 171:

```tsx
disabled={isMatchLocked || isSurpriseEntrantsFull}
```

And the `onKeyDown` handler at line 162-167, add an early return:

```tsx
onKeyDown={(event) => {
  if (event.key !== "Enter") return;
  event.preventDefault();
  if (isMatchLocked || isSurpriseEntrantsFull) return;
  onAddBattleRoyalEntrant(match.id, battleRoyalEntryInput);
}}
```

And each autocomplete suggestion button at line 196-207:

```tsx
disabled={isMatchLocked || isSurpriseEntrantsFull}
```

**Step 3: Run lint and type-check**

Run: `npx next lint && npx tsc --noEmit`
Expected: PASS

**Step 4: Commit**

```
feat: enforce surprise entrant limit in player app UI
```

---

### Task 2: Fix leader badge for ties at #1

The leaderboard panel shows "Leader" badge on `index === 0` which is wrong when multiple players tie for rank 1. It should show the badge on ALL entries with `rank === 1`, or show no badge if there's a tie.

**Files:**
- Modify: `components/pick-em/shared/leaderboard-panel.tsx`

**Step 1: Show leader badge on all rank-1 entries**

In the display variant (line 54-59), change:

```tsx
{index === 0 ? (
```

to:

```tsx
{entry.rank === 1 ? (
```

This ensures all tied-at-#1 players get the Leader badge. (Alternative was hiding it entirely on ties, but showing both is more informative and aligns with the UAT note "show both leader".)

**Step 2: Run lint and type-check**

Run: `npx next lint && npx tsc --noEmit`
Expected: PASS

**Step 3: Commit**

```
fix: show leader badge on all rank-1 entries for ties
```

---

### Task 3: Hide lock events from fullscreen overlay

Lock events (`lock.global`, `lock.match`, `lock.matchBonus`, `lock.eventBonus`) currently trigger fullscreen popups. UAT says these are not important enough for fullscreen treatment. They should still appear in the updates feed, just not trigger the overlay.

**Files:**
- Modify: `components/pick-em/live-game-display-app.tsx`
- Modify: `components/pick-em/live-game-player-app.tsx`

**Step 1: Add lock events to the hidden set in display app**

In `live-game-display-app.tsx`, change the `FULLSCREEN_HIDDEN_EVENT_TYPES` set (line 48-52) to:

```tsx
const FULLSCREEN_HIDDEN_EVENT_TYPES = new Set([
  "player.submitted",
  "player.pending",
  "player.denied",
  "lock.global",
  "lock.match",
  "lock.matchBonus",
  "lock.eventBonus",
]);
```

**Step 2: Add lock events to hidden set in player app**

In `live-game-player-app.tsx`, add lock events to `PLAYER_FULLSCREEN_HIDDEN_EVENT_TYPES` (line 68-74):

```tsx
const PLAYER_FULLSCREEN_HIDDEN_EVENT_TYPES = new Set([
  "player.submitted",
  "player.pending",
  "player.denied",
  "player.joined",
  "player.approved",
  "lock.global",
  "lock.match",
  "lock.matchBonus",
  "lock.eventBonus",
]);
```

**Step 3: Run lint and type-check**

Run: `npx next lint && npx tsc --noEmit`
Expected: PASS

**Step 4: Commit**

```
fix: suppress lock events from fullscreen popup overlay
```

---

### Task 4: Show entrant name in fullscreen entry order event

Currently the `key.entryOrder` event messages from the server already include the entrant name (e.g. `"Match 3 entrant #5 recorded: John Cena"`). This message is displayed in the fullscreen popup. Verify this works and if the message format needs adjustment.

**Files:**
- Verify: `lib/server/repositories/live-games.ts` (lines 918-932) — already generates `"entrant #N recorded: {name}"` messages

**Step 1: Verify message format in server code**

Read `lib/server/repositories/live-games.ts` lines 918-932. The server already generates these messages:
- `"{matchLabel} entrant order started ({count} recorded)"` — when first entrant(s) added
- `"{matchLabel} entrant #{N} recorded: {name}"` — when a single new entrant is added
- `"{matchLabel} entrant order updated ({count} recorded)"` — when order is rearranged

The single-entrant case already includes the name. The "started" and "updated" cases show counts but not names.

**Step 2: Improve "started" message to include the entrant names**

In `lib/server/repositories/live-games.ts`, find the block near line 913-917 where `previousEntryOrder.length === 0` (entrant order started). Change the message to include names:

```typescript
events.push({
  type: "key.entryOrder",
  message: `${matchLabel} entrant order started: ${nextEntryOrder.slice(0, 3).join(", ")}${nextEntryOrder.length > 3 ? ` (+${nextEntryOrder.length - 3} more)` : ""}`,
});
```

**Step 3: Run lint and type-check**

Run: `npx next lint && npx tsc --noEmit`
Expected: PASS

**Step 4: Commit**

```
feat: include entrant names in entry order event messages
```

---

### Task 5: Increase font sizes in display app for TV

Font sizes need to be bigger across the display app components for TV viewing distance. This affects the header, leaderboard, updates feed, and fullscreen overlays.

**Files:**
- Modify: `components/pick-em/live-display/display-header.tsx`
- Modify: `components/pick-em/shared/leaderboard-panel.tsx` (display variant)
- Modify: `components/pick-em/live-display/active-game-view.tsx`
- Modify: `components/pick-em/shared/updates-feed.tsx` (display variant)
- Modify: `components/pick-em/shared/fullscreen-effect-overlay.tsx`
- Modify: `components/pick-em/live-display/lobby-view.tsx`

**Step 1: Increase display header font sizes**

In `display-header.tsx`:
- Event name `h1` (line 35): Change `text-4xl` → `text-5xl`
- Join code span (line 40): Change `text-lg` → `text-xl`
- Stat numbers (lines 56, 62, 68): Change `text-xl` → `text-2xl`
- Status label "Live Lobby"/"Live Leaderboard" (line 30): Change `text-sm` → `text-base`
- Stat labels (lines 54, 60, 66): Change `text-xs` → `text-sm`

**Step 2: Increase leaderboard panel display font sizes**

In `leaderboard-panel.tsx` display variant:
- Column headers (line 32): Change `text-xs` → `text-sm`
- Rank number (line 60): Change `text-xl` → `text-2xl`
- Player name (line 63): Change `text-lg` → `text-xl`
- Score (line 72): Change `text-2xl` → `text-3xl`
- Status text (line 64): Change `text-sm` → `text-base`

**Step 3: Increase fullscreen overlay font sizes**

In `fullscreen-effect-overlay.tsx`:
- Title text (line 40): Change `text-2xl` → `text-3xl`
- Event type label (line 51): Change `text-xs` → `text-sm`
- Event message (line 54): Change `text-base` → `text-lg`
- Leaderboard title (line 93): Change `text-2xl` → `text-3xl`
- Player rank+name (line 123): Change `text-base` → `text-lg`
- Score (line 133): Change `text-lg` → `text-xl`

**Step 4: Increase lobby view font sizes**

In `lobby-view.tsx`:
- Player nickname (line 100): Change `text-base` → `text-lg`
- "Scan To Join" heading (line 38): Change `text-sm` → `text-base`
- Join URL text (line 54): Change `text-xs` → `text-sm`

**Step 5: Run lint and type-check**

Run: `npx next lint && npx tsc --noEmit`
Expected: PASS

**Step 6: Commit**

```
style: increase font sizes across display app for TV readability
```

---

### Task 6: Merge leaderboard shift into same fullscreen popup as triggering events

Currently, when events cause a leaderboard change, two separate fullscreen popups are shown sequentially: first the events panel, then the leaderboard shift panel. UAT wants them combined into a single popup.

**Files:**
- Modify: `hooks/use-fullscreen-effects.ts` — add a combined effect type
- Modify: `components/pick-em/shared/fullscreen-effect-overlay.tsx` — render combined view
- Modify: `components/pick-em/live-game-display-app.tsx` — produce combined effects
- Modify: `components/pick-em/live-game-player-app.tsx` — produce combined effects

**Step 1: Add combined effect type to the hook**

In `hooks/use-fullscreen-effects.ts`, add a new effect type after line 19:

```typescript
export interface FullscreenCombinedEffect {
  kind: "combined";
  events: { id: string; type: string; message: string }[];
  previous: LiveGameLeaderboardEntry[];
  current: LiveGameLeaderboardEntry[];
  swapCount: number;
}

export type FullscreenEffect =
  | FullscreenEventsEffect
  | FullscreenLeaderboardEffect
  | FullscreenCombinedEffect;
```

Update `getFullscreenEffectDurationMs` to handle "combined":

```typescript
function getFullscreenEffectDurationMs(effect: FullscreenEffect): number {
  if (effect.kind === "events") return EVENT_EFFECT_DURATION_MS;
  if (effect.kind === "leaderboard") {
    return (
      LEADERBOARD_EFFECT_BASE_DURATION_MS +
      effect.swapCount * LEADERBOARD_SWAP_DURATION_MS
    );
  }
  // combined: events display time + leaderboard animation time
  return (
    EVENT_EFFECT_DURATION_MS +
    effect.swapCount * LEADERBOARD_SWAP_DURATION_MS
  );
}
```

In the `useEffect` that drives leaderboard animation (line 89), also handle "combined":

```typescript
if (!activeEffect || (activeEffect.kind !== "leaderboard" && activeEffect.kind !== "combined")) {
  setAnimatedLeaderboardOrder([]);
  return;
}
```

And use `activeEffect.previous` / `activeEffect.current` which exist on both leaderboard and combined types.

**Step 2: Render combined effect in overlay**

In `fullscreen-effect-overlay.tsx`, add handling for the "combined" kind. When `activeEffect.kind === "combined"`, render both the events list AND the leaderboard shift panel together in a single fullscreen panel:

```tsx
{activeEffect.kind === "combined" ? (
  <div className="lg-fullscreen-effect-panel">
    <div className="lg-fullscreen-effect-title">
      <Sparkles className="h-6 w-6" />
      <span className="font-heading text-3xl uppercase tracking-wide">
        Live Results
      </span>
    </div>
    <div className="lg-fullscreen-effect-body">
      {activeEffect.events.map((event, index) => (
        <div
          key={event.id}
          className="lg-fullscreen-event-item"
          style={{ animationDelay: `${index * 110}ms` }}
        >
          <p className="text-sm uppercase tracking-wide text-primary/90">
            {formatEventTypeLabel(event.type)}
          </p>
          <p className="text-lg text-foreground">{event.message}</p>
        </div>
      ))}
    </div>
    <div className="mt-4 border-t border-border/30 pt-4">
      <div className="flex items-center gap-3 mb-3">
        <Trophy className="h-5 w-5 text-primary" />
        <span className="font-heading text-xl uppercase tracking-wide">
          Leaderboard Shift
        </span>
      </div>
      <Reorder.Group
        axis="y"
        values={animatedLeaderboardOrder.length > 0
          ? animatedLeaderboardOrder
          : activeEffect.previous.map((e) => e.nickname)}
        onReorder={() => {}}
        className="lg-fullscreen-reorder-list"
      >
        {/* Same leaderboard row rendering as LeaderboardShiftPanel */}
      </Reorder.Group>
    </div>
  </div>
) : null}
```

Note: Extract the leaderboard rows rendering into a shared helper or inline it. The key data comes from `activeEffect.previous`, `activeEffect.current`, and `animatedLeaderboardOrder`.

**Step 3: Produce combined effects in display app**

In `live-game-display-app.tsx`, in the polling loop (lines 242-274), instead of pushing separate events and leaderboard effects, merge them when both exist:

```typescript
const queuedFullscreenEffects: FullscreenEffect[] = [];
const hasNewEvents = fullscreenAddedEvents.length > 0;
const leaderboardChanged = hasLeaderboardChanged(previous, loaded);

if (hasNewEvents && leaderboardChanged) {
  const bubbleSteps = buildBubbleSortSteps(
    previous.leaderboard
      .slice(0, FULLSCREEN_LEADERBOARD_LIMIT)
      .map((entry) => entry.nickname),
    loaded.leaderboard
      .slice(0, FULLSCREEN_LEADERBOARD_LIMIT)
      .map((entry) => entry.nickname),
  );
  queuedFullscreenEffects.push({
    kind: "combined",
    events: fullscreenAddedEvents.slice(0, 4),
    previous: previous.leaderboard.slice(0, FULLSCREEN_LEADERBOARD_LIMIT),
    current: loaded.leaderboard.slice(0, FULLSCREEN_LEADERBOARD_LIMIT),
    swapCount: Math.max(1, bubbleSteps.length - 1),
  });
  vibrateForeground(UPDATE_VIBRATE_PATTERN);
} else if (hasNewEvents) {
  queuedFullscreenEffects.push({
    kind: "events",
    events: fullscreenAddedEvents.slice(0, 4),
  });
  vibrateForeground(UPDATE_VIBRATE_PATTERN);
} else if (leaderboardChanged) {
  const bubbleSteps = buildBubbleSortSteps(
    previous.leaderboard
      .slice(0, FULLSCREEN_LEADERBOARD_LIMIT)
      .map((entry) => entry.nickname),
    loaded.leaderboard
      .slice(0, FULLSCREEN_LEADERBOARD_LIMIT)
      .map((entry) => entry.nickname),
  );
  queuedFullscreenEffects.push({
    kind: "leaderboard",
    previous: previous.leaderboard.slice(0, FULLSCREEN_LEADERBOARD_LIMIT),
    current: loaded.leaderboard.slice(0, FULLSCREEN_LEADERBOARD_LIMIT),
    swapCount: Math.max(1, bubbleSteps.length - 1),
  });
}
queueEffects(queuedFullscreenEffects);
```

**Step 4: Apply same pattern in player app**

In `live-game-player-app.tsx`, in the `applyGameUpdate` callback (lines 205-232), apply the same combined-effect logic: merge events + leaderboard into a single "combined" effect when both are present.

**Step 5: Run lint and type-check**

Run: `npx next lint && npx tsc --noEmit`
Expected: PASS

**Step 6: Commit**

```
feat: combine event and leaderboard shift into single fullscreen popup
```

---

### Task 7: Set display app to 100dvh with no scrolling

The display app should fill exactly the viewport height with no overflow scrolling. This is critical for TV display.

**Files:**
- Modify: `components/pick-em/live-game-display-app.tsx`

**Step 1: Change root layout to 100dvh with overflow-hidden**

In `live-game-display-app.tsx`, change the root `<div>` (line 402) from:

```tsx
<div className="min-h-screen px-6 py-6">
```

to:

```tsx
<div className="flex h-dvh flex-col overflow-hidden px-6 py-6">
```

**Step 2: Make the body section fill remaining space**

Ensure `ActiveGameView` and `LobbyView` use `flex-1 min-h-0 overflow-hidden` so they fill remaining space after the header without overflowing.

Wrap the view section (lines 438-446) in a flex-1 container:

```tsx
<div className="min-h-0 flex-1">
  {state.game.status === "lobby" ? (
    <LobbyView ... />
  ) : (
    <ActiveGameView ... />
  )}
</div>
```

Update `LobbyView` root div to add `h-full` so it fills the available space:

```tsx
<div className="grid h-full gap-5 lg:grid-cols-[1.1fr_1.4fr] lg:items-start">
```

Update `ActiveGameView` root div similarly:

```tsx
<div className="grid h-full gap-5 lg:grid-cols-[2fr_1fr]">
```

**Step 3: Run lint and type-check**

Run: `npx next lint && npx tsc --noEmit`
Expected: PASS

**Step 4: Commit**

```
fix: constrain display app to 100dvh with no scrolling
```

---

### Task 8: Make QR code larger in display lobby view

The QR code should fill most of the space in the bottom-left section of the lobby display. Currently it's `h-72 w-72 lg:h-80 lg:w-80` (288-320px).

**Files:**
- Modify: `components/pick-em/live-display/lobby-view.tsx`

**Step 1: Increase QR code size**

In `lobby-view.tsx`, change the QR code `<img>` (line 43-47) from:

```tsx
className="h-72 w-72 rounded-md bg-white p-2 lg:h-80 lg:w-80"
```

to:

```tsx
className="aspect-square w-full max-w-[420px] rounded-md bg-white p-3"
```

This makes the QR code fill the available width (up to 420px) instead of a fixed small size.

Also in `live-game-display-app.tsx` where QR code is generated (line 349-351), increase the QR data URL resolution:

```tsx
const qrUrl = await QRCode.toDataURL(joinUrl, {
  width: 560,
  margin: 1,
});
```

**Step 2: Run lint and type-check**

Run: `npx next lint && npx tsc --noEmit`
Expected: PASS

**Step 3: Commit**

```
style: enlarge QR code in display lobby view
```

---

### Task 9: Add game-ended screen to display app

When the game status is `"ended"`, the display app should show a dedicated end screen with final standings instead of the live view.

**Files:**
- Create: `components/pick-em/live-display/ended-view.tsx`
- Modify: `components/pick-em/live-game-display-app.tsx`

**Step 1: Create EndedView component**

Create `components/pick-em/live-display/ended-view.tsx`:

```tsx
"use client";

import React from "react";
import { Trophy } from "lucide-react";

import type { LiveGameStateResponse } from "@/lib/client/live-games-api";
import { LeaderboardPanel } from "@/components/pick-em/shared/leaderboard-panel";

interface EndedViewProps {
  state: LiveGameStateResponse;
}

function EndedViewInner({ state }: EndedViewProps) {
  return (
    <div className="flex h-full flex-col items-center justify-center gap-6">
      <div className="text-center">
        <Trophy className="mx-auto h-16 w-16 text-primary" />
        <h2 className="mt-4 font-heading text-5xl font-semibold uppercase tracking-wide">
          Final Standings
        </h2>
        <p className="mt-2 text-lg text-muted-foreground">
          {state.card.eventName || "Event"} has ended
        </p>
      </div>
      <div className="w-full max-w-3xl rounded-2xl border border-border/70 bg-card/90 p-6 shadow-xl shadow-black/25 backdrop-blur">
        <LeaderboardPanel
          leaderboard={state.leaderboard}
          variant="display"
        />
      </div>
    </div>
  );
}

export const EndedView = React.memo(EndedViewInner);
```

**Step 2: Route to EndedView in display app**

In `live-game-display-app.tsx`, import the new component and update the conditional (lines 438-446):

```tsx
import { EndedView } from "./live-display/ended-view";

// In the render section:
<div className="min-h-0 flex-1">
  {state.game.status === "lobby" ? (
    <LobbyView ... />
  ) : state.game.status === "ended" ? (
    <EndedView state={state} />
  ) : (
    <ActiveGameView state={state} />
  )}
</div>
```

**Step 3: Run lint and type-check**

Run: `npx next lint && npx tsc --noEmit`
Expected: PASS

**Step 4: Commit**

```
feat: add dedicated game-ended screen to display app
```

---

### Task 10: Add game-ended screen to player app

When `state.game.status === "ended"`, the player app should show a final results screen with the player's rank, score, and the final leaderboard — instead of editable picks.

**Files:**
- Create: `components/pick-em/live-player/player-ended-view.tsx`
- Modify: `components/pick-em/live-game-player-app.tsx`

**Step 1: Create PlayerEndedView component**

Create `components/pick-em/live-player/player-ended-view.tsx`:

```tsx
"use client";

import React from "react";
import { Trophy } from "lucide-react";

import type { LiveGameStateResponse } from "@/lib/client/live-games-api";
import { LeaderboardPanel } from "@/components/pick-em/shared/leaderboard-panel";

interface PlayerEndedViewProps {
  state: LiveGameStateResponse;
  myRank: { rank: number; score: number } | null;
}

function PlayerEndedViewInner({ state, myRank }: PlayerEndedViewProps) {
  return (
    <div className="flex flex-col items-center gap-6 py-8">
      <div className="text-center">
        <Trophy className="mx-auto h-12 w-12 text-primary" />
        <h2 className="mt-3 font-heading text-3xl font-semibold uppercase tracking-wide">
          Game Over
        </h2>
        <p className="mt-1 text-sm text-muted-foreground">
          {state.card.eventName || "Event"} has ended
        </p>
        {myRank ? (
          <div className="mt-4 inline-flex items-center gap-3 rounded-xl border border-primary/30 bg-primary/10 px-6 py-3">
            <span className="font-heading text-2xl">#{myRank.rank}</span>
            <span className="text-muted-foreground">|</span>
            <span className="font-mono text-2xl font-semibold">
              {myRank.score} pts
            </span>
          </div>
        ) : null}
      </div>
      <div className="w-full rounded-xl border border-border/70 bg-card/90 p-4 shadow-lg shadow-black/20 backdrop-blur">
        <h3 className="mb-2 font-semibold">Final Leaderboard</h3>
        <LeaderboardPanel
          leaderboard={state.leaderboard}
          variant="compact"
        />
      </div>
    </div>
  );
}

export const PlayerEndedView = React.memo(PlayerEndedViewInner);
```

**Step 2: Route to PlayerEndedView in player app**

In `live-game-player-app.tsx`, import the new component and conditionally render it when the game has ended. Replace the match picks / bonus picks / tiebreaker / sidebar section (lines 731-789) with a conditional:

```tsx
import { PlayerEndedView } from "./live-player/player-ended-view";

// In the render section, after PlayerHeader:
{state.game.status === "ended" ? (
  <PlayerEndedView state={state} myRank={myRank ? { rank: myRank.rank, score: myRank.score } : null} />
) : (
  <>
    {state.card.matches.map((match, index) => (
      <PlayerMatchPicks ... />
    ))}
    <PlayerEventBonusPicks ... />
    <PlayerTiebreakerInput ... />
    <section className="grid gap-4 lg:grid-cols-2">
      {/* leaderboard + updates sidebar */}
    </section>
  </>
)}
```

**Step 3: Run lint and type-check**

Run: `npx next lint && npx tsc --noEmit`
Expected: PASS

**Step 4: Commit**

```
feat: add dedicated game-ended screen to player app
```
